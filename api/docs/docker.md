# Dockerç’°å¢ƒã®è©³ç´°èª¬æ˜

## ğŸ³ Dockeræ§‹æˆ

æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã€ä»¥ä¸‹ã®ã‚µãƒ¼ãƒ“ã‚¹ã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ï¼š

- **api**: Rails APIã‚µãƒ¼ãƒãƒ¼ (Puma)
- **worker**: Sidekiqãƒ¯ãƒ¼ã‚«ãƒ¼ï¼ˆãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«è¨­å®šã§åˆ†é›¢å¯èƒ½ï¼‰
- **db**: MySQL 8.0ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
- **redis**: Redis 7ã‚­ãƒ£ãƒƒã‚·ãƒ¥/ã‚¸ãƒ§ãƒ–ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸

## ğŸ“¦ Dockerfileã®æ§‹æˆ

### ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰

`Dockerfile.api`ã¯ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ï¼š

1. **builder**: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨ã‚¢ã‚»ãƒƒãƒˆã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚’è¡Œã†
2. **runtime**: å®Ÿè¡Œã«å¿…è¦ãªæœ€å°é™ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã¿ã‚’å«ã‚€è»½é‡ã‚¤ãƒ¡ãƒ¼ã‚¸

ã“ã®æ§‹æˆã«ã‚ˆã‚Šã€æœ¬ç•ªã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚µã‚¤ã‚ºã‚’æœ€å°é™ã«æŠ‘ãˆã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã‚’è»½æ¸›ã—ã¦ã„ã¾ã™ã€‚

```dockerfile
# ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸ - gemã®ãƒ“ãƒ«ãƒ‰ã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’è¡Œã†
FROM ruby:3.3-slim AS builder
# ... ãƒ“ãƒ«ãƒ‰æ™‚ã®ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€gemã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç­‰ ...

# æœ¬ç•ªç”¨ã‚¹ãƒ†ãƒ¼ã‚¸ - å¿…è¦ãªãƒ©ãƒ³ã‚¿ã‚¤ãƒ ä¾å­˜é–¢ä¿‚ã®ã¿å«ã‚ã‚‹
FROM ruby:3.3-slim AS runtime
# ... æœ€å°é™ã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ä¾å­˜é–¢ä¿‚ã®ã¿ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« ...
```

### æ³¨æ„ç‚¹

- **Node.jsä¾å­˜**: æœ¬ç•ªç’°å¢ƒã§CSSã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãªã©ã«Node.jsãŒå¿…è¦ãªãŸã‚ã€`nodejs`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’runtimeã‚¹ãƒ†ãƒ¼ã‚¸ã«ã‚‚å«ã‚ã¦ã„ã¾ã™ã€‚
- **ã‚¢ã‚»ãƒƒãƒˆã‚³ãƒ³ãƒ‘ã‚¤ãƒ«**: ã‚¢ã‚»ãƒƒãƒˆã¯`builder`ã‚¹ãƒ†ãƒ¼ã‚¸ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã€çµæœã®ã¿ã‚’`runtime`ã‚¹ãƒ†ãƒ¼ã‚¸ã«ã‚³ãƒ”ãƒ¼ã—ã¦ã„ã¾ã™ã€‚

## ğŸ” docker-compose.yml

é–‹ç™ºç’°å¢ƒã§ã¯`docker-compose.yml`ã‚’ä½¿ç”¨ã—ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ã«æ§‹æˆã—ã¦ã„ã¾ã™ï¼š

```yaml
services:
  db:
    image: mysql:8.0
    # ... è¨­å®š ...
  
  redis:
    image: redis:7-alpine
    # ... è¨­å®š ...
  
  api:
    build: 
      context: .
      dockerfile: Dockerfile.api
    # ... è¨­å®š ...
    
  worker:
    profiles: ["production-like"]  # æœ¬ç•ªç’°å¢ƒã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ™‚ã®ã¿èµ·å‹•
    # ... è¨­å®š ...
```

### ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«

`profiles`æ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¦ã€ä¸€éƒ¨ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ç‰¹å®šã®ç›®çš„ã§ã®ã¿èµ·å‹•ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ï¼š

```bash
# æ¨™æº–ã®é–‹ç™ºç’°å¢ƒï¼ˆAPIãƒ—ãƒ­ã‚»ã‚¹ãŒSidekiqã‚‚å†…éƒ¨ã§èµ·å‹•ï¼‰
docker compose up

# æœ¬ç•ªç’°å¢ƒã«è¿‘ã„æ§‹æˆï¼ˆSidekiqã‚’åˆ¥ãƒ—ãƒ­ã‚»ã‚¹ã§èµ·å‹•ï¼‰
docker compose --profile production-like up
```

## ğŸ“‡ .dockerignore

ã‚³ãƒ³ãƒ†ãƒŠãƒ“ãƒ«ãƒ‰æ™‚ã«ä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–ã—ã€ãƒ“ãƒ«ãƒ‰é€Ÿåº¦ã®å‘ä¸Šã¨ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚ºã®å‰Šæ¸›ã‚’å›³ã£ã¦ã„ã¾ã™ï¼š

```
# ãƒ†ã‚¹ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯é–‹ç™ºæ™‚ã«ã¯ãƒ›ã‚¹ãƒˆã‹ã‚‰ãƒã‚¦ãƒ³ãƒˆ
# /spec/

# ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«
/tmp/

# Gité–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«
/.git/
```

> **æ³¨**: `/spec/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã‚¤ãƒ¡ãƒ¼ã‚¸é™¤å¤–ã¯ã€Dockerå†…ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã«å•é¡Œã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚å¿…è¦ã«å¿œã˜ã¦`.dockerignore`ã‹ã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¦ãã ã•ã„ã€‚

## ğŸ”„ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯

å„ã‚µãƒ¼ãƒ“ã‚¹ã«ã¯é©åˆ‡ãªãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãŒè¨­å®šã•ã‚Œã¦ãŠã‚Šã€ä¾å­˜é–¢ä¿‚ã®èµ·å‹•é †åºã‚’åˆ¶å¾¡ã—ã¦ã„ã¾ã™ï¼š

```yaml
db:
  healthcheck:
    test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "--silent"]
    timeout: 5s
    retries: 10

redis:
  healthcheck:
    test: ["CMD", "redis-cli", "ping"]
    interval: 1s
    timeout: 3s
    retries: 30
```

APIã‚³ãƒ³ãƒ†ãƒŠã¯ã€ã“ã‚Œã‚‰ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ãŸå¾Œã«ã®ã¿èµ·å‹•ã—ã¾ã™ï¼š

```yaml
api:
  depends_on:
    db:
      condition: service_healthy
    redis:
      condition: service_healthy
```

## ğŸ”§ ãƒœãƒªãƒ¥ãƒ¼ãƒ 

ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨æ°¸ç¶šæ€§ã®ãŸã‚ã«ã€ã„ãã¤ã‹ã®ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’è¨­å®šã—ã¦ã„ã¾ã™ï¼š

```yaml
volumes:
  db_data:  # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–
  bundle_cache:  # Rubygemã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  yarn_cache:  # Yarnãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
```

## ğŸ–¥ï¸ Dev Containers / Codespaces å¯¾å¿œ

VSCode Dev Containersã¾ãŸã¯GitHub Codespacesã¨äº’æ›æ€§ã®ã‚ã‚‹`.devcontainer.json`ã‚’æä¾›ï¼š

```json
{
  "name": "eventa",
  "dockerComposeFile": "docker-compose.yml",
  "service": "api",
  "workspaceFolder": "/app",
  "postStartCommand": "bin/setup || true",
  "mounts": [ 
    "source=eventa_gems,target=/usr/local/bundle,type=volume",
    "source=eventa_yarn,target=/home/vscode/.cache/yarn,type=volume",
    "source=eventa_node_modules,target=/app/.node_modules_cache,type=volume"
  ],
  "postAttachCommand": "yarn install --immutable --silent"
}
``` 