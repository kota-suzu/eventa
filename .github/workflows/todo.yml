name: "TODO to Issue"

# TODO(!enhancement): 複数ラベル対応を追加する（例: TODO(!urgent !backend): のような形式）
# alstr/todo-to-issue-action が対応しているか確認するか、カスタムパーサーの実装を検討する

# TODO: 定期実行（scheduled）を追加して、一定期間ごとにコードベースをスキャンして Issue 化することを検討する

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      # 自動生成ファイルや頻繁に変更されるファイルを除外
      - '**/*.lock'
      - '**/*.md'

jobs:
  todo:
    runs-on: ubuntu-latest
    # GitHub IssueへのWrite権限を追加
    permissions:
      issues: write
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 差分検出のために完全履歴が必要

      # TODOコメントをIssue化
      - name: Convert TODO / FIXME to Issues
        uses: alstr/todo-to-issue-action@v5
        with:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # 旧式のCOMMENT_PATTERNからIDENTIFIERSへ移行
          IDENTIFIERS: |
            [
              {"name": "TODO", "labels": ["todo"]},
              {"name": "TODO\\(!enhancement\\)", "labels": ["todo", "enhancement"]},
              {"name": "TODO\\(!security\\)", "labels": ["todo", "security"]},
              {"name": "TODO\\(!feature\\)", "labels": ["todo", "feature"]},
              {"name": "TODO\\(!urgent\\)", "labels": ["todo", "urgent"]},
              {"name": "TODO\\(!backend\\)", "labels": ["todo", "backend"]},
              {"name": "TODO\\(!frontend\\)", "labels": ["todo", "frontend"]},
              {"name": "FIXME", "labels": ["bug", "fix-needed"]},
              {"name": "OPTIMIZE", "labels": ["performance"]},
              {"name": "HACK", "labels": ["tech-debt"]},
              {"name": "NOTE", "labels": ["documentation"]}
            ]
          # 課題が解決されたらIssueを自動的に閉じる
          CLOSE_ISSUES: true
          # 生成されたIssueのURLをコメントに挿入
          INSERT_ISSUE_URLS: true
          # チームのデフォルト担当者
          AUTO_ASSIGN: 'kota-suzu'
          # 対象外のファイルやディレクトリ（INCLUDE_PATTERNの代わり）
          IGNORE: |
            node_modules/
            vendor/
            **/*.lock
            **/*.md

# TODO: スケジュール実行の追加を検討する
# 定期的に全コードベースをスキャンし、漏れなくTODOコメントをIssue化する