# ユーザー新規登録機能仕様書

**ドキュメントバージョン**: 1.0  
**最終更新日**: 2023-10-01  
**カテゴリ**: 認証・ユーザー管理  
**機能ID**: USER-REG-001

## 1. 概要

本仕様書は、Eventaプラットフォームにおけるユーザー新規登録機能の詳細な仕様を定義します。この機能により、ユーザーはEventaプラットフォームに新規アカウントを作成し、イベント参加者（guest）またはイベント主催者（organizer）としてサービスを利用できるようになります。

## 2. 機能定義

### 2.1 機能範囲

- ユーザー新規登録フォームの提供
- 入力情報のバリデーション
- アカウント作成処理
- 登録成功後の自動ログインと初期ページ表示
- (将来的実装) メールアドレス確認プロセス

### 2.2 対象ユーザー

- イベント参加者として利用したい一般ユーザー
- イベント主催者として利用したい企業・団体・個人

### 2.3 前提条件

- 未登録のユーザーであること
- 有効なメールアドレスを保有していること
- 利用規約およびプライバシーポリシーに同意できること

## 3. 機能詳細

### 3.1 ユーザー新規登録フロー

1. ユーザーが登録ページ (`/register` または `/signup`) にアクセス
2. 必要情報を入力
   - メールアドレス (必須)
   - 氏名 (必須)
   - パスワード (必須)
   - パスワード確認 (必須)
   - ユーザータイプ: 一般参加者/イベント主催者 (必須、デフォルトは一般参加者)
   - 利用規約同意 (必須)
3. 「登録」ボタンをクリック
4. システムがバリデーションを実行
5. エラーがあれば表示し、修正を促す
6. 入力内容が正しければユーザーレコードを作成
7. JWT認証トークンを発行
8. ユーザーをログイン状態にする
9. 適切なページへリダイレクト
   - 一般参加者: イベント一覧ページ (`/events`)
   - イベント主催者: ダッシュボード (`/dashboard`)

### 3.2 入力項目仕様

| フィールド名 | 種類 | 必須 | バリデーション | 初期値 | 説明 |
|------------|-----|-----|--------------|-------|-----|
| email | テキスト | ◯ | メールフォーマット<br>一意性<br>最大255文字 | 空 | ユーザーの連絡先メールアドレス |
| name | テキスト | ◯ | 最大50文字 | 空 | ユーザーの表示名 |
| password | パスワード | ◯ | 最小8文字<br>最大72文字 | 空 | ログイン用パスワード |
| password_confirmation | パスワード | ◯ | passwordと一致 | 空 | パスワード確認用 |
| role | ラジオボタン | ◯ | `guest`または`organizer` | `guest` | ユーザー種別 |
| terms_accepted | チェックボックス | ◯ | `true`であること | `false` | 利用規約同意確認 |

### 3.3 バリデーションルール詳細

#### 3.3.1 サーバーサイドバリデーション

```ruby
# User model validation
validates :email, presence: true, 
                  format: { with: URI::MailTo::EMAIL_REGEXP }, 
                  uniqueness: { case_sensitive: false }
validates :name, presence: true, length: { maximum: 50 }
validates :password, presence: true, 
                     length: { minimum: 8, maximum: 72 }, 
                     if: -> { password.present? || new_record? }
validates :role, presence: true, inclusion: { in: %w[guest organizer admin] }
validates :terms_accepted, acceptance: true
```

#### 3.3.2 クライアントサイドバリデーション

- リアルタイムバリデーション（フォーカスが外れたとき）
- 送信前の全項目バリデーション
- パスワード強度インジケーター表示
- 重複メールアドレス非同期チェック

### 3.4 エラーメッセージ

| エラー種別 | メッセージ | 表示位置 |
|----------|----------|---------|
| 必須入力不足 | "[フィールド名]は必須です" | フィールド下部 |
| メール形式不正 | "有効なメールアドレスを入力してください" | メールフィールド下部 |
| メール重複 | "このメールアドレスは既に使用されています" | メールフィールド下部 |
| パスワード短い | "パスワードは8文字以上にしてください" | パスワードフィールド下部 |
| パスワード不一致 | "パスワードが一致しません" | 確認フィールド下部 |
| 利用規約未同意 | "利用規約に同意する必要があります" | チェックボックス下部 |
| サーバーエラー | "登録処理中にエラーが発生しました。時間をおいて再度お試しください。" | フォーム上部 |

### 3.5 API仕様

#### 3.5.1 新規登録API

- エンドポイント: `POST /api/v1/auth/register`
- コンテンツタイプ: `application/json`
- リクエストボディ:
  ```json
  {
    "user": {
      "email": "user@example.com",
      "name": "山田 太郎",
      "password": "password123",
      "password_confirmation": "password123",
      "role": "guest",
      "terms_accepted": true
    }
  }
  ```

- 成功レスポンス (201 Created):
  ```json
  {
    "data": {
      "id": "123",
      "type": "user",
      "attributes": {
        "email": "user@example.com",
        "name": "山田 太郎",
        "role": "guest",
        "email_verified": false,
        "created_at": "2023-10-01T10:00:00Z"
      }
    },
    "meta": {
      "token": "eyJhbGciOiJIUzI1NiJ9...",
      "expires_at": "2023-10-08T10:00:00Z"
    }
  }
  ```

- エラーレスポンス (422 Unprocessable Entity):
  ```json
  {
    "status": "error",
    "errors": [
      "メールアドレスは既に使用されています",
      "パスワードは8文字以上である必要があります"
    ]
  }
  ```

## 4. UI仕様

### 4.1 画面レイアウト

登録ページは、以下のコンポーネントで構成されます:

1. **ヘッダー**
   - Eventaロゴ（ホームページへのリンク）
   - 「ログイン」へのリンク

2. **メインコンテンツ**
   - 登録フォームコンテナ（中央配置、最大幅500px）
   - 「新規登録」タイトル
   - 入力フォーム
   - 送信ボタン
   - 「すでにアカウントをお持ちですか？」ログインへのリンク

3. **フッター**
   - コピーライト情報
   - 利用規約・プライバシーポリシーリンク

### 4.2 スタイリング

- フォームコンテナ: 白背景、角丸、ドロップシャドウ
- 入力フィールド: 十分な高さ（44px以上）、フォーカス時の青枠
- エラーメッセージ: 赤色テキスト
- 送信ボタン: プライマリーカラー（青）、ホバー時に濃い青
- フォーム間隔: 要素間に十分なスペース

### 4.3 レスポンシブ対応

- モバイル（〜767px）: フォーム幅95%、フォント小さめ
- タブレット（768px〜1023px）: フォーム幅80%
- デスクトップ（1024px〜）: フォーム幅500px固定

## 5. セキュリティ要件

1. パスワードは常にハッシュ化して保存（bcrypt）
2. 通信は常にHTTPS経由
3. リクエスト時のCSRF対策
4. レート制限によるブルートフォース攻撃防止
5. バリデーションによるインジェクション攻撃防止
6. ログインセッションは適切なタイムアウト設定

## 6. テスト要件

### 6.1 単体テスト

- ユーザーモデルバリデーションテスト
- 登録コントローラーアクションテスト

### 6.2 統合テスト

- 有効なデータによる登録フロー
- 無効なデータによるバリデーション
- 既存メールアドレスを使用した場合の競合処理

### 6.3 UI/UXテスト

- 全入力フィールドのバリデーション動作
- エラーメッセージの適切な表示
- ローディングインジケーターの確認
- 登録成功後の自動リダイレクト

## 7. 今後の拡張予定

1. **メール確認フロー**
   - 登録時に確認メール送信
   - メールリンククリックで確認完了

2. **ソーシャルログイン**
   - Google
   - Facebook
   - LINE

3. **ユーザープロフィール拡張**
   - アバター画像
   - 自己紹介
   - SNSリンク

## 8. 関連ドキュメント

- [認証全体設計書](../design/auth_design.md)
- [新規登録機能詳細設計](../design/user_registration_design.md)
- [API全体仕様書](./api_reference.md)

---

## 改訂履歴

| 日付 | バージョン | 内容 | 担当者 |
|------|----------|------|--------|
| 2023-10-01 | 1.0 | 初版作成 | Auth Team | 