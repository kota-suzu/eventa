# eventa 新規登録機能 Design Doc (v0.1)

**ステータス**: Draft 0.1  
**作成日**: 2023-10-01  
**作成者**: Auth Team  
**レビュー担当**: Tech Lead / UX Designer / Product Manager / Security Team

## 目的 (Why)

イベント管理プラットフォーム eventa において、ユーザーがセキュアかつ円滑に新規アカウントを作成できる機能を設計・実装する。一般ユーザー（イベント参加者）とイベント主催者の両方のユーザータイプを考慮し、必要最小限の情報収集とセキュリティを両立させる。

## 機能要件

| ID | 要件 | 優先度 | 備考 |
|----|-----|-------|------|
| REG-01 | Eメール+パスワードによる新規登録 | Must | 基本登録フロー |
| REG-02 | ユーザーロール選択（guest/organizer） | Must | 登録時に選択 |
| REG-03 | メールアドレス確認プロセス | Should | 確認メール送信 |
| REG-04 | バリデーション（パスワード強度、重複確認） | Must | クライアント+サーバーサイド |
| REG-05 | 利用規約・プライバシーポリシー同意 | Must | 法的要件 |
| REG-06 | 登録後の自動ログイン | Must | シームレスな体験 |
| REG-07 | ソーシャルログイン連携による登録 | Could | 将来拡張 |

## 設計詳細

### データモデル

既存の`User`モデルを利用し、必要な属性は以下の通り：

```ruby
# User model attributes
t.string :email, null: false
t.string :name, null: false
t.string :password_digest, null: false
t.string :role, null: false, default: 'guest'  # [guest, organizer, admin]
t.boolean :email_verified, default: false
t.datetime :email_verification_sent_at
t.string :email_verification_token
t.timestamps
```

### API エンドポイント

**POST /api/v1/auth/register**

リクエスト:
```json
{
  "user": {
    "email": "user@example.com",
    "password": "securepassword123",
    "password_confirmation": "securepassword123",
    "name": "山田 太郎",
    "role": "guest"
  }
}
```

レスポンス (成功 - 201 Created):
```json
{
  "data": {
    "id": "123",
    "type": "user",
    "attributes": {
      "email": "user@example.com",
      "name": "山田 太郎",
      "role": "guest",
      "email_verified": false
    }
  },
  "meta": {
    "token": "eyJhbGciOiJIUzI1NiJ9...",
    "expires_at": "2023-10-08T10:00:00Z"
  }
}
```

レスポンス (エラー - 422 Unprocessable Entity):
```json
{
  "status": "error",
  "errors": [
    "メールアドレスは既に使用されています",
    "パスワードは8文字以上である必要があります"
  ]
}
```

### バリデーションルール

1. **メールアドレス**:
   - 必須項目
   - 有効なフォーマット（RFC準拠）
   - 一意性（重複不可）

2. **パスワード**:
   - 最低8文字以上
   - 英字・数字の混合推奨
   - 確認フィールドとの一致

3. **名前**:
   - 必須項目
   - 最大50文字

4. **ロール**:
   - 必須項目
   - 許可値: [`guest`, `organizer`]

### セキュリティ考慮事項

1. **パスワード管理**:
   - bcryptによるセキュアなハッシュ化
   - パスワード強度指標の提供（フロントエンド）

2. **レート制限**:
   - IP単位: 1時間に10回までの登録試行
   - 同一メールアドレス: 24時間に3回までの登録試行

3. **CSRF対策**:
   - APIリクエストにおけるトークン検証

4. **個人情報保護**:
   - 必要最小限の情報のみ収集
   - プライバシーポリシーへの同意徴求
   - GDPRコンプライアンス考慮

### ユーザーフロー

1. ユーザーが「新規登録」ボタンをクリック
2. 登録フォームに必要情報を入力
   - メールアドレス
   - パスワード（+確認用）
   - 名前
   - ユーザータイプ（一般/主催者）
   - 利用規約への同意
3. フォーム送信（クライアントサイドバリデーション）
4. サーバーサイドバリデーション
5. ユーザーレコード作成
6. JWT認証トークン発行
7. 登録成功レスポンス返却
8. （オプション）確認メール送信
9. フロントエンドで自動ログイン処理
10. ダッシュボードまたはウェルカムページへリダイレクト

## UI設計

### 登録フォーム

フォームは以下の要素を含む:

1. Eventaロゴ/ブランディング
2. 「新規登録」ヘッダー
3. 入力フィールド:
   - メールアドレス（必須）
   - 名前（必須）
   - パスワード（必須）
   - パスワード確認（必須）
   - ユーザータイプ選択（ラジオボタン）
4. 利用規約同意チェックボックス
5. 「登録」ボタン
6. 「すでにアカウントをお持ちの方」リンク

### フィードバック表示

- インラインバリデーションエラー（赤文字）
- フォーム送信エラー（トップに赤枠メッセージ）
- 送信中ローディング表示（ボタンローディング状態）
- 成功時フィードバック（自動リダイレクト前のフラッシュメッセージ）

## テスト計画

### バックエンドテスト

1. **単体テスト**:
   - ユーザーモデルバリデーション
   - 登録アクション処理

2. **統合テスト**:
   - 有効な登録リクエスト
   - 無効な登録リクエスト（各バリデーションエラー）
   - レート制限テスト

### フロントエンドテスト

1. **コンポーネントテスト**:
   - バリデーション機能
   - フォームサブミット処理

2. **E2Eテスト**:
   - 登録フロー全体
   - エラー表示
   - リダイレクト

## モニタリング計画

1. **パフォーマンス指標**:
   - 登録成功率
   - 平均登録完了時間
   - エラー発生率（タイプ別）

2. **セキュリティモニタリング**:
   - 登録試行の異常検知
   - 大量登録アラート

## 今後の拡張

1. **ソーシャルログイン連携**:
   - Google, Facebook, LINE, Twitter

2. **高度な不正防止**:
   - reCAPTCHA連携
   - 行動分析による不正検知

3. **プログレッシブ登録**:
   - 最小情報での初期登録
   - 段階的なプロフィール完成フロー

## 実装スケジュール

| フェーズ | 作業 | 期間 | 担当 |
|---------|------|------|------|
| 要件定義 | 詳細仕様確定 | 3日間 | PM + Auth Team |
| バックエンド | APIエンドポイント実装 | 4日間 | バックエンドエンジニア |
| フロントエンド | 登録UI実装 | 5日間 | フロントエンドエンジニア |
| テスト | 統合テスト実施 | 3日間 | QAエンジニア |
| ドキュメント | API仕様書更新 | 2日間 | テクニカルライター |

## レビュー履歴

| バージョン | 日付 | レビュアー | コメント |
|----------|------|-----------|---------|
| 0.1 | 2023-10-01 | Auth Team | 初期ドラフト作成 | 